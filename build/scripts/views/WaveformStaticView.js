define([],function(){var e=Backbone.View.extend({initialize:function(){_.bindAll(this);var e=this,t=this.$el;this.component=this.options.component,this.color="#0000FF",this.status="No audio loaded",this.animateWaveform=!0,this.currentPos=[0,0],this.peaks=[];var n=env==="web"?_.template($("#stack-module-static-waveform").html()):templates.stack_module_static_waveform,r=env==="web"?_.template($("#waveform-menu-bar").html()):templates.waveform_menu_bar;this.tooltipTemplate=env==="web"?_.template($("#mouse-tooltip-template").html()):templates.mouse_tooltip_template,t.append(r()),t.append(n(this.component)),this.canvas=t.find("canvas")[0],this.overlayCanvas=t.find("canvas")[1],this.selectionCanvas=t.find("canvas")[2],this.context=this.canvas.getContext("2d"),this.overlayContext=this.overlayCanvas.getContext("2d"),this.selectionContext=this.selectionCanvas.getContext("2d"),this.mouse={},this.selection={threshold:1,duration:0},t.find(".file-menu").on("change",this.onFileMenuChange),t.find(".edit-menu").on("change",this.onEditMenuChange),t.find(".process-menu").on("change",this.onProcessMenuChange),this.canvas.width=this.selectionCanvas.width=this.overlayCanvas.width=4096,this.module=this.model.get("module"),this.module.on("audio-loaded",this.build),this.module.on("status-update",this.onStatusUpdate),this.module.on("play",this.drawLoop),this.module.on("stop",this.clearProgress),this.module.on("file-read",this.onFileRead),this.$el.find(".frosted-glass").on("mousedown",this.onMouseDown).on("mouseup",this.onMouseUp).on("mousemove",this.onMouseMove).on("mouseover",this.onMouseOver).on("mouseout",this.onMouseOut).on("dblclick",this.onDoubleClick)},build:function(e){this.buffer=this.module.getBuffer(),this.getPeaks()},clearWaveform:function(){var e=this.context;e.clearRect(0,0,this.canvas.width,this.canvas.height)},clearProgress:function(){var e=this.overlayContext;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height)},onStatusUpdate:function(e,t){this.$el.find(".waveform-status").html(e),t>=100&&this.clearStatus()},_getMousePosition:function(e){var t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},onFileRead:function(){this.animateWaveform=!0},onDoubleClick:function(e){this.module.setPosition(0),this.clearSelection(),this.clearProgress()},onMouseClick:function(e){var t=this._getMousePosition(e),n=$(this.canvas).width(),r=t.x/n,i=this.module.getDuration()*r;this.module.setPosition(i),this.clearSelection(),this.module.isPlaying||this.drawProgress()},onMouseDown:function(e){var t=this._getMousePosition(e),n=this.module.getDuration()*(t.x/$(this.canvas).width());this.mouse.pressed=!0,this.mouse.startX=t.x,this.mouse.startY=t.y,this.selection.set?n<this.selection.startTime+this.selection.duration/2?this.selection.tempStartTime=this.selection.endTime:n>this.selection.endTime-this.selection.duration/2&&(this.selection.tempStartTime=this.selection.startTime):this.selection.tempStartTime=n},onMouseUp:function(e){var t=this._getMousePosition(e),n;this.mouse.pressed=!1,this.mouse.distanceX>this.selection.threshold||this.mouse.distanceX<-this.selection.threshold?(this.selection.endTime=this.module.getDuration()*(t.x/$(this.canvas).width()),this.selection.startTime=this.selection.tempStartTime,this.selection.startTime>this.selection.endTime&&(n=this.selection.startTime,this.selection.startTime=this.selection.endTime,this.selection.endTime=n),this.selection.set=!0,this.selection.duration=this.selection.endTime-this.selection.startTime,this.module.setSelection(this.selection.startTime,this.selection.endTime)):(this.module.clearSelection(),this.onMouseClick(e))},onMouseOver:function(e){$("#tooltip-container").removeClass("hide")},onMouseOut:function(e){$("#tooltip-container").addClass("hide"),this.mouse.pressed&&this.onMouseUp(e)},onMouseMove:function(e){var t=this._getMousePosition(e),n=t.x-this.mouse.startX,r=this.module.getDuration()*(t.x/$(this.canvas).width());if(this.mouse.pressed){this.mouse.distanceX=n;if(n>this.selection.threshold||n<-this.selection.threshold)this.selection.tempEndTime=r,this.drawSelection()}else this.mouse.distanceX=0;this.renderTooltip(e)},renderTooltip:function(e){$("#tooltip-container").html(this.tooltipTemplate(this.getMouseTime(e))).css({top:e.clientY-50,left:e.clientX-35})},getMouseTime:function(e){var t=this._getMousePosition(e),n=$(this.canvas).width(),r=t.x/n,i=this.module.getDuration()*r;return{minutes:~~(i%3600/60),seconds:i%60,milliseconds:(i%60-~~(i%60))*1e3}},clearStatus:function(){this.$el.find(".waveform-status").html("")},getPeaks:function(){var e=this,t=this.module.getBuffer(),n=0,r=this.module.getChannelData(),i=r[0].length/4096%0?r[0].length/4096:~~(r[0].length/4096+.5);this.fps=t.length/t.duration,this.fpp=r[0].length/this.canvas.width,this.animateWaveform&&this.clearWaveform(),debug.log("WAVEFORM: Sending to worker manager..."),WorkerManager.addJob({action:"waveform-peaks",data:r,split:r[0].length/4096,width:4096,totalProcesses:4096,onSplit:this.module.splitBuffers,onReconstruct:function(t){e.animateWaveform||e.draw(e.peaks),e.clearStatus(),e.animateWaveform=!1},onProgress:function(t,n){debug.log(n),e.animateWaveform&&e.drawFrame(n.processID,n.data[0]),e.module.trigger("status-update","Building waveform... "+t+"%",t),e.peaks[n.processID]=n.data[0]}}),this.onStatusUpdate("Building waveform...")},drawLoop:function(){this.module.isPlaying&&(this.model.get("collapsed")||this.drawProgress(),requestAnimFrame(this.drawLoop))},clearSelection:function(){this.selectionContext.clearRect(0,0,this.selectionCanvas.width,this.selectionCanvas.height),this.selection.startTime=0,this.selection.endTime=0,this.selection.set=!1},drawProgress:function(){var e=this.overlayContext,t=this.module.getPosition()*this.fps/this.fpp,n=this.selection.set?this.selection.startTime*this.fps/this.fpp:0;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),e.fillStyle="rgba(255,255,255, 0.6)",e.fillRect(n,0,t-n,this.overlayCanvas.height)},drawSelection:function(){var e=this.selectionContext,t=this.selection.tempStartTime*this.fps/this.fpp,n=this.selection.tempEndTime*this.fps/this.fpp,r,i;t>n?r=t-n:r=n-t,e.clearRect(0,0,this.selectionCanvas.width,this.selectionCanvas.height),e.fillStyle="rgb(0,0,0)",e.fillRect(t,0,1,this.selectionCanvas.height),e.fillRect(n-1,0,1,this.selectionCanvas.height),e.fillStyle="rgba(0,0,0,0.25)",e.fillRect(t,0,n-t,this.selectionCanvas.height)},draw:function(){var e=this.context,t=this.canvas,n=this;e.clearRect(0,0,this.canvas.width,this.canvas.height),_.each(this.peaks,function(e,t){n.drawFrame(t,e)})},drawFrame:function(e,t,n){var r=1,i=Math.round(t*this.canvas.height),s=e*r,o=Math.round((this.canvas.height-i)/2);this.context.fillStyle="#DBDBDB",this.context.fillRect(s,o,r,i)},onFileMenuChange:function(e){switch(e.target.selectedOptions[0].value){case"export":this.module.export();break;case"export selection":this.module.exportSelection()}e.target.selectedIndex=0},onEditMenuChange:function(e){var t=this;switch(e.target.selectedOptions[0].value){case"trim to selection":this.module.trimToSelection(function(){t.clearSelection(),t.clearProgress(),t.module.clearSelection(),t.module.setPosition(0)});break;case"cut":this.module.cutSelection();break;case"paste":this.module.insertBuffer();break;case"copy":this.module.copySelection()}e.target.selectedIndex=0},onProcessMenuChange:function(e){var t=this;switch(e.target.selectedOptions[0].value){case"normalize":this.module.normalize();break;case"adjust gain":this.module.adjustGain()}e.target.selectedIndex=0}});return e});