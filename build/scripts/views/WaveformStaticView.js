define([],function(){var e=Backbone.View.extend({initialize:function(){_.bindAll(this);var e=this,t=this.$el;this.component=this.options.component,this.color="#0000FF",this.status="No audio loaded";var n=env==="web"?_.template($("#stack-module-static-waveform").html()):templates.stack_module_static_waveform;t.html(n(this.component)),this.canvas=t.find("canvas")[0],this.overlayCanvas=t.find("canvas")[1],this.context=this.canvas.getContext("2d"),this.overlayContext=this.overlayCanvas.getContext("2d"),this.canvas.width=this.overlayCanvas.width=4096,this.module=this.model.get("module"),this.module.on("audio-loaded",this.build),this.module.on("status-update",this.onStatusUpdate),this.module.on("play",this.drawLoop),this.module.on("stop",this.clearProgress)},build:function(e){this.buffer=this.module.getBuffer(),this.getPeaks()},clearWaveform:function(){var e=this.context;e.clearRect(0,0,this.canvas.width,this.canvas.height)},clearProgress:function(){var e=this.overlayContext;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height)},onStatusUpdate:function(e){this.clearWaveform(),this.$el.find(".waveform-status").html(e)},clearStatus:function(){this.$el.find(".waveform-status").html("")},getPeaks:function(){var e=this,t=this.module.getBuffer(),n=function(){var e=[];for(var n=0;n<t.numberOfChannels;n++)e.push(t.getChannelData(n));return e}();this.fps=t.length/t.duration,this.fpp=n[0].length/this.canvas.width,worker.postMessage({action:"waveform-peaks",data:n,width:this.canvas.width}),worker.onmessage=function(t){t.data.action==="waveform-peaks"&&(e.peaks=t.data.data,e.draw(t.data.data),e.clearStatus())},this.onStatusUpdate("Building waveform...")},drawLoop:function(){this.module.isPlaying&&(this.model.get("collapsed")||this.drawProgress(),requestAnimFrame(this.drawLoop))},drawProgress:function(){var e=this.overlayContext,t=this.module.getPosition()*this.fps/this.fpp;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),e.fillStyle="rgba(255,255,255, 0.7)",e.fillRect(0,0,t,this.overlayCanvas.height)},draw:function(){var e=this.context,t=this.canvas,n=_.max(this.peaks),r=this;e.clearRect(0,0,this.canvas.width,this.canvas.height),_.each(this.peaks,function(e,t){r.drawFrame(t,e,n)})},drawFrame:function(e,t,n){var r=1,i=Math.round(t*(this.canvas.height/n)),s=e*r,o=Math.round((this.canvas.height-i)/2);this.context.fillStyle="#DBDBDB",this.context.fillRect(s,o,r,i)}});return e});