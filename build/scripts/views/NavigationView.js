define(["views/PresetLoaderView","models/PresetCollection","views/HelpView","models/HelpCollection"],function(e,t,n,r){var i=Backbone.View.extend({className:"navbar",events:{"click .add-module-btn":"onAddModule","click .cancel-add-btn":"onAddModule","change .main-menu select":"onMenuChange","blur #bpm input":"onBpmChange","keydown #bpm input":"onBpmChange"},initialize:function(){_.bindAll(this);var i=this;this.stack=this.options.stack,this.template=env==="web"?_.template($("#templates #navbar-template").html()):templates.navbar_template,this.$container=$("#navbar-container"),this.model.set({saveOpen:!1,loadOpen:!1,aboutOpen:!1,helpOpen:!1}),this.presetLoaderView=new e({collection:new t,$container:this.$container}),this.helpView=new n({collection:r,$container:this.$container}),this.stack.getPresets(function(e){i.presetLoaderView.collection.reset(e),i.presetLoaderView.collection.on("load",function(e){i.stack.load(e)})}),global_relay.on("global-open",this.onLoad),global_relay.on("global-save",this.onSave),global_relay.on("global-help",this.onHelp),global_relay.on("global-expand",function(){i.onCollapseAll(0)}),global_relay.on("global-collapse",function(){i.onCollapseAll(1)}),global_relay.on("global-about",this.onAbout),this.render()},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$container.html(this.$el),this.$container.append(env==="web"?_.template($("#templates #save-input-template").html(),{}):templates.save_input_template()).after(env==="web"?_.template($("#templates #about-template").html(),{version:globals.version}):templates.about_template({version:"0.1"})),this.$saveDialog=this.$container.find("#save-dialog"),this.$aboutDialog=$("#about-dialog"),this.$aboutDialog.find(".close").on("click",this.toggleAbout),this.$saveDialog.on("keydown",this.onSaveSubmit),$(window).on("resize",this.onResize).trigger("resize")},onResize:function(e){this.$aboutDialog.css({left:window.innerWidth/2-this.$aboutDialog.width()/2,top:window.innerHeight/2-this.$aboutDialog.height()/2})},onAddModule:function(e){var t=$(e.target).hasClass("add-module-btn")?"addClass":"removeClass",n=t==="addClass"?"removeClass":"addClass";$("#module-loader")[t]("selected").siblings("#effects-stack")[n]("selected"),$(".left-rail, .right-rail")[t]("hide"),$(".main-view-hide")[t]("hide"),this.$el.find(".add-module-btn")[t]("hide").siblings(".cancel-add-btn")[n]("hide")},onMenuChange:function(e){var t=e.target.selectedOptions[0].value;switch(t){case"load":this.onLoad();break;case"save":this.onSave();break;case"settings":this.onSettings();break;case"about":this.onAbout();break;case"collapseAll":this.onCollapseAll(1);break;case"expandAll":this.onCollapseAll(0);break;case"help":this.onHelp();break;case"metronome":this.onMetronomeToggle()}e.target.selectedIndex=0},toggleAbout:function(){var e=this,t=this.model.get("aboutOpen"),n=t?"addClass":"removeClass";this.$aboutDialog[n]("hide"),$(".body-overlay")[n]("hide"),t?$(window).off("keydown",this.onSaveSubmit):($(window).on("keydown",function(t){(t.keyCode===27||t.keyCode===13)&&e.toggleAbout()}),this.onResize()),this.model.set("aboutOpen",!t)},toggleSaveDialog:function(){var e=this.model.get("saveOpen"),t=e?"addClass":"removeClass";this.$saveDialog[t]("hide"),$(".body-overlay")[t]("hide"),e||this.$saveDialog.find("input").focus(),this.model.set("saveOpen",!e)},toggleLoadDialog:function(){var e=this.model.get("saveOpen"),t=e?"addClass":"removeClass";this.model.set("loadOpen",!e)},onLoad:function(){this.presetLoaderView.toggle()},onSave:function(){this.toggleSaveDialog()},onSaveSubmit:function(e){var t=this;switch(e.keyCode){case 13:this.stack.save(e.target.value,function(e){t.presetLoaderView.collection.add(e)});case 27:e.target.value="",this.toggleSaveDialog();break;default:}},onSettings:function(){this.options.settings.trigger("show")},onBpmChange:function(e){if(e.type==="keydown"){if(e.keyCode!==13)return;$(e.target).blur();return}if(!e.target.validity.valid){e.target.value=this.stack.BPM;return}var t=parseInt(e.target.value,10);this.stack.BPM=t,this.stack.trigger("change:BPM")},onAbout:function(){this.toggleAbout()},onHelp:function(){this.helpView.onToggle()},onCollapseAll:function(e){this.stack.invoke("setCollapsed",e)}});return i});