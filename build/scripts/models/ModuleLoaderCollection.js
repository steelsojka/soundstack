define(["models/BaseModel"],function(e){var t=Backbone.Collection.extend({url:env==="web"?"api/web-service.php?request=get_modules&v="+_.random(0,1e5):"modules.json",model:e,initialize:function(){_.bindAll(this),global_relay.on("stop-record",this.onStopRecord)},parse:function(e){return e.modules},onStopRecord:function(e){var t=this.getModuleByName("Audio Player"),n=e.getBuffer(function(n){var r=!1;for(var i=0,s=n.length;i<s;i++)r||(r=n[i].length>0);if(!r)return;t.loadModule(function(){global_relay.trigger("load-recorded-audio",t,function(t){var r=t.get("module");r.importBuffer(n),e.clear()})})})},getModuleByName:function(e){return this.find(function(t){return t.get("name")===e})},_getModules:function(e){var t=[],n,r,i;for(var s=0,o=e.modules.length;s<o;s++)n=e.modules[s],i=_.omit(n,"settings"),t.push({globals:i,settings:n.settings,model:this.find(function(e){return parseInt(e.get("id"),10)===parseInt(n.id,10)})});return _.without(t,_.last(t))},getModulesToLoad:function(e,t){var n=this,r,i,s,o;e=e,env==="web"?e in localStorage&&(r=JSON.parse(localStorage.getItem(e)),_.isFunction(t)&&t(this._getModules(r))):env==="app"&&chrome.storage.sync.get(e,function(i){r=i[e],_.isFunction(t)&&t(n._getModules(r))})},getPresets:function(e){var t=[];if(env==="web"){for(var n=0,r=localStorage.length;n<r;n++){var i=localStorage.key(n);i.search("preset")!==-1&&t.push({presetName:i.replace("ss-preset-",""),key:i})}_.isFunction(e)&&e(t)}else env==="app"&&chrome.storage.sync.get(null,function(n){t=_.filter(n,function(e){return e.key.search("preset")!==-1}),_.isFunction(e)&&e(t)})}});return t});