define(["models/ModuleInstanceModel","components/AudioContext","models/BaseModel","modules/MasterOut"],function(e,t,n,r){var i={version:1,"interface":[[{type:"button",name:"Record",disableClass:"","class":"int-width-half",addClassOnPress:"pressed-red",removeClassOnEvent:[{event:"stop-record",_class:"pressed-red"}],func:{name:"record",parameters:[{type:"Integer",value:0}]}},{type:"button",name:"Stop",disableClass:"","class":"int-width-half",func:{name:"stopRecord",parameters:[{type:"Integer",value:0}]}},{type:"slider",name:"Output",minValue:0,maxValue:2,defaultValue:1,step:.01,orientation:"horizontal",disableClass:"",behavior:"log",func:{name:"setGain",parameters:[{type:"Float",value:"@VALUE@"}]}},{type:"meter",name:"Output Left",channel:0},{type:"meter",name:"Output Right",channel:1}]]},s=Backbone.Collection.extend({model:e,initialize:function(){_.bindAll(this);var e=this;window.stack=this,this.BPM=120,this.context=(new t).getContext(),this.on("add",this.connectStack),this.on("reset",this.initializeStack),this.on("positions-updated",this.connectStack),this.on("bypass-fx reference-select",this.connectStack),this.on("manual-connect",function(){e.connectStack()}),this.on("remove",this.onRemove),this.on("change:BPM",this.updateBPM),global_relay.on("load-recorded-audio",function(t,n){e.createModule(t,undefined,undefined,n)}),global_relay.on("get-recorder",function(t){t(e.getRecorder())}),this.initializeStack()},initializeStack:function(){window.masterOut=new e({module:new r(this.context),name:"Output",category:"Output",disable:1,collapsed:0,draggable:0,position:1,removable:0,enabled:1,"interface":i}),this.add(masterOut)},getRecorder:function(){var e=this.find(function(e){return e.get("name")==="Output"});return e.get("module").getRecorder()},load:function(e){var t=this;this.loader.getModulesToLoad(e,function(e){var n=t.pluck("module");_.invoke(_.compact(n),"destroy"),t.each(function(e){t.trigger("load-remove",e)}),t.reset(),t._loadIndex=0,t._load(e)})},_load:function(e){var t=this,n=this,r=e[this._loadIndex],i=e;r.model.loadModule(function(){n.createModule(r.model,r.settings,r.globals,function(){_.isUndefined(i[t._loadIndex+1])||(t._loadIndex++,t._load(i))})})},getPresets:function(e){this.loader.getPresets(e)},save:function(e,t){var n=[];this.each(function(e){var t={};for(var r in e.attributes)if(e.attributes.hasOwnProperty(r)){var i=typeof e.attributes[r];i!=="function"&&i!=="object"&&(t[r]=e.attributes[r])}t.settings=e.attributes.settings,n.push(t)});var r="ss_preset_"+e,i={key:r,presetName:e,modules:n},s={};s["ss_preset_"+e]=i,env==="web"?(localStorage.setItem("ss-preset-"+e,JSON.stringify(i)),_.isFunction(t)&&t(i)):env==="app"&&chrome.storage.sync.set(s,function(){_.isFunction(t)&&t(i)})},checkSource:function(){var e=this;this.each(function(t){t.get("category")==="Source"&&e.remove(t)})},onRemove:function(e){e.get("module").destroy(),this.connectStack()},updateItemPosition:function(e,t){var n=this.models[e],r=_.without(this.models,n);r.splice(t,0,n),this.models=r,this.trigger("positions-updated")},connectStack:function(){var e=this.pluck("module"),t,n,r=this.last().get("module").getReferenceNode(),i=this;_.invoke(e,"disconnectAll"),this.each(function(e,t){var s=e.get("module");t===i.length-1?s.connectToMaster():e.get("category")==="Source"?(n=i.chain().filter(function(e){return e.get("category")!=="Source"}).first().value(),s.reference?s.connect(r):e.get("bypassFx")?s.connect(i.last().get("module")):s.connect(n.get("module"))):s.connect(i.models[t+1].get("module"))}),this.updateBPM()},updateBPM:function(){this.invoke("setBpm",this.BPM)},createModule:function(e,t,n,r){var i=this,s=!_.isUndefined(t),o=e.createInstance(this.context),u=this.length,a=o.get("fix_position"),f=o.get("interface_path"),l=parseInt(o.get("version"),10),c=parseInt(o.get("cach_interface"),10),h="interface-"+f,p=o.get("category").toLowerCase();a=a?parseInt(a):a;var d=a===0?0:a===1?u:u-1,v=!0;_.isUndefined(n)||o.set(n),o.get("enabled")?o.enable():o.disable();if(env==="app"){this.add(o,{at:d}),s&&o.applySettings(t),_.isFunction(r)&&r(o);return}if(h in localStorage){var m=JSON.parse(localStorage.getItem(h)),g=parseInt(m.version,10);l===g&&(o.set("interface",m),p==="source",this.add(o,{at:d}),s&&o.applySettings(t),v=!1),_.isFunction(r)&&r(o)}v&&$.get("api/web-service.php?request=get_interface&v="+_.random(0,1e5)+"&module="+f+"&version="+l,function(e){localStorage.setItem(h,JSON.stringify(e)),o.set("interface",e),p==="source"&&i.checkSource(),i.add(o,{at:d}),s&&o.applySettings(t),_.isFunction(r)&&r(o)})}});return s});