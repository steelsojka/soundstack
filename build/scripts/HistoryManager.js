(function(e){var t=function(e){this.module=e,this.settings=_.clone(e.get("settings"))};t.prototype.applyLevel=function(){this.module.applySettings(this.settings,!0)},t.prototype.destroy=function(){this.module.off("change:history")},t.prototype.getSettings=function(){return this.module.get("settings")};var n=function(){r.push(new t(this),!0)},r={levels:[],redoLevels:[],listening:!1,maxLevels:25,listen:function(){this.listening=!0},push:function(e,t){this.levels.length>=this.maxLevels&&this.levels.shift(),this.levels.push(e),t&&(this.redoLevels=[])},pushRedo:function(e){this.redoLevels.length>=this.maxLevels&&this.redoLevels.shift(),this.redoLevels.push(e)},undo:function(){if(this.levels.length<1)return;var e=this.levels.pop(),n=new t(e.module);e.applyLevel(),this.pushRedo(n)},redo:function(){if(this.redoLevels.length<1)return;var e=this.redoLevels.pop();this.push(new t(e.module)),e.applyLevel()},register:function(e){e.on("change:history",n)},unregister:function(e){var t=_.filter(this.levels,function(t){return t.module===e});_.invoke(t,"destroy"),this.levels=_.filter(this.levels,function(t){return t.module!==e})}};_.bindAll(r),global_relay.on("global-undo",r.undo),global_relay.on("global-redo",r.redo),e.HistoryManager=r})(this);