define(["modules/BaseModule","components/AudioFile"],function(e,t){var n=e.extend({init:function(e){_.bindAll(this),_.extend(this,Backbone.Events),this._super.apply(this,arguments),this._enablePlay=!1,this.spectrumType=2,this.currentPosition=0,this.contextStartTime=0,this.playFromPosition=0,this.isPlaying=!1,this.reference=!1;var n=new t(this.context);this.nodes.audioSource=n,this.connectToOutput(n),this.enable=function(){this._enabled=!0},this.disable=function(){this.pause(),this._enabled=!1},global_relay.on("global-play",this.play),global_relay.on("global-stop",this.stop)},onFileLoad:function(e,t){var n=e.target.files,r=new FileReader,i=this;this.stop(),r.onload=function(e){i.onFileRead(e,t)},r.readAsArrayBuffer(n[0]),this._enablePlay=!1},getBuffer:function(){return this.nodes.audioSource.getBuffer.apply(this.nodes.audioSource,arguments)},onFileRead:function(e,t){var n=this;n.trigger("status-update","Decoding audio..."),this.nodes.audioSource.decodeAudio(e.target.result,function(){n.onAudioDecode(e,t)})},importBuffer:function(e){this.nodes.audioSource.setSource(e,this.onAudioDecode)},onAudioDecode:function(e,t){this._enablePlay=!0;var n=this;this.duration=this.nodes.audioSource.getDuration(),n.trigger("audio-loaded"),typeof t=="function"&&t()},setLoop:function(e){this.loop=e},setReference:function(e){this.reference=e,this.isPlaying=!e,this.trigger("reference-change",e)},play:function(){if(!this._enablePlay||!this._enabled)return;this.isPlaying?this.pause():(this.contextStartTime=this.context.currentTime,this.playFromPosition=this.currentPosition,this.nodes.audioSource.unpause(),this.nodes.audioSource.start(0,this.currentPosition,this.duration-this.currentPosition),this.isPlaying=!0,this.trigger("play"),requestAnimFrame(this.onFrame))},pause:function(){this.nodes.audioSource.stop(0),this.isPlaying=!1,this.trigger("pause")},onFrame:function(){this.isPlaying&&(this.currentPosition=this.playFromPosition+(this.context.currentTime-this.contextStartTime),requestAnimFrame(this.onFrame),this.currentPosition>=this.duration&&(this.loop?this.restartLoop():this.stop()))},restartLoop:function(){this.stop(),this.play()},setGain:function(e){this.nodes.audioSource.setGain(e)},"export":function(){var e=this.nodes.audioSource.getBuffer(),t=[];for(var n=0;n<e.numberOfChannels;n++)t.push(e.getChannelData(n));global_relay.trigger("get-recorder",function(e){e.exportWAV(function(e){Recorder.forceDownload(e)},"audio/wav",t)})},getPosition:function(){return this.currentPosition},getStartTime:function(){return this.contextStartTime},stop:function(e){this.isPlaying=!1,this.currentPosition=0,this.playFromPosition=0,this.nodes.audioSource.stop(0),this.trigger("stop")},destroy:function(){this.stop(),this.nodes=null,global_relay.off("global-play",this.play),global_relay.off("global-stop",this.stop)}});return n});