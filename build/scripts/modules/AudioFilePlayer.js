define(["modules/BaseModule","components/AudioFile"],function(e,t){var n=e.extend({init:function(e){_.bindAll(this),_.extend(this,Backbone.Events),this._super.apply(this,arguments),this._enablePlay=!1,this.spectrumType=2,this.currentPosition=0,this.contextStartTime=0,this.playFromPosition=0,this.isPlaying=!1,this.reference=!1,this.selection={},this.clipboard={buffer:[]},this.gainAdjustmentFactor=.5,this.enableProcessing=!1,this.SAMPLE_RATE=44100,this.tempBuffer={start:0,end:0,data:[],temps:[]};var n=new t(this.context);this.nodes.audioSource=n,this.connectToOutput(n),this.enable=function(){this._enabled=!0},this.disable=function(){this.pause(),this._enabled=!1},global_relay.on("global-play",this.play),global_relay.on("global-stop",this.stop)},onFileLoad:function(e,t){var n=e.target.files,r=new FileReader,i=this;this.stop(),r.onload=function(e){i.onFileRead(e,t)},r.readAsArrayBuffer(n[0]),this._enablePlay=!1},getBuffer:function(){return this.nodes.audioSource.getBuffer.apply(this.nodes.audioSource,arguments)},onFileRead:function(e,t){var n=this;n.trigger("status-update","Decoding audio... please wait"),n.trigger("file-read"),this.nodes.audioSource.decodeAudio(e.target.result,function(){n.onAudioDecode(e,t)})},importBuffer:function(e,t){var n=this;console.log("importing buffer start"),n.trigger("status-update","Importing buffer..."),this.nodes.audioSource.setSource(e,function(){n.onAudioDecode({},t)})},splitBuffers:function(e,t,n){debug.log("AUDIO FILE PLAYER: Splitting buffers..."),debug.Timer.start();var r=[],i=e.data,s=0;for(var o=0,u=i[0].length;o<u;o+=t){var a=i.length,f=u-o<t?u:o+t,l=[];while(a--)l.push({data:Array.prototype.slice.call(i[a],o,f),altData:{_pos:o}});n(l)}return debug.log("AUDIO FILE PLAYER: Buffers split in "+debug.Timer.stop()+"s"),r},onAudioDecode:function(e,t){this._enablePlay=!0;var n=this;this.duration=this.nodes.audioSource.getDuration(),this.trigger("audio-loaded"),this.enableProcessing=!0,typeof t=="function"&&t()},setLoop:function(e){this.loop=e,this.isPlaying&&(this.pause(),this.play())},setRate:function(){this.nodes.audioSource.setRate.apply(this.nodes.audioSource,arguments)},setPosition:function(e){this.currentPosition=e,this.isPlaying&&(this.pause(),this.play())},trimToSelection:function(e){var t=this;if(!this.enableProcessing)return;this.enableProcessing=!1,t.trigger("status-update","Trimming selection..."),this.getSelectionBuffer(function(n){t.importBuffer(n,e)})},setSelection:function(e,t){this.selection.start=e,this.selection.end=t,this.selection.set=!0,this.currentPosition=e,this.isPlaying&&(this.pause(),this.play())},clearSelection:function(){this.selection.start=0,this.selection.end=0,this.selection.set=!1},replaceBufferSelection:function(e,t){var n=this,r=this.selection.start*this.SAMPLE_RATE,i=this.selection.end*this.SAMPLE_RATE;WorkerManager.addJob({action:"replace-buffer-section",start:r,end:i,data:this.getChannelData(),split:500,replaceBuffers:e,onReconstruct:function(e){t(n.reconstructBuffer(e))},onProgress:function(e,t){n.onProgress("Replacing buffer...",e)},onSplit:function(e){var t=[],n=e.data,r=e.replaceBuffers,i=Math.round(e.start),s=i+r[0].length,o=e.split;for(var u=0,a=n.length;u<a;u++){var f=r[u].length,l=[],c=n[u];for(var h=0,p=c.length;h<p;h+=o){var d=[],v=0;if(h>=i&&h<=s){var m=h-i>o?o:h-i;d=Array.prototype.splice.call(r[u],0,m),v=o-m}l.push({data:Array.prototype.slice.call(c,h,h+o),altData:{_pos:h,_rPos:v,_rBuff:d.slice(0)}})}t.push(l)}return t}})},cutSelection:function(e){var t=this;if(!this.selection.set)return;if(!this.enableProcessing)return;this.enableProcessing=!1,WorkerManager.addJob({action:"cut-buffer",data:this.getChannelData(),start:this.selection.start*this.SAMPLE_RATE,end:this.selection.end*this.SAMPLE_RATE,split:500,onSplit:t.splitBuffers,onReconstruct:function(n){console.log("copying to clipboard"),t.clipboard.buffer=t.reconstructBuffer(_.pluck(n,"cutBuffers")),console.log("importing buffer from cut"),t.importBuffer(t.reconstructBuffer(_.pluck(n,"buffers")),e)},onProgress:function(e){t.onProgress("Cutting selection...",e)}})},copySelection:function(){var e=this;if(!this.selection.set)return;if(!this.enableProcessing)return;this.enableProcessing=!1,this.getSelectionBuffer(function(t){e.clipboard.buffer=t,e.enableProcessing=!0})},insertBuffer:function(e){var t=this;if(this.clipboard.buffer.length===0)return;if(!this.enableProcessing)return;this.enableProcessing=!1;var n=this.getChannelData(),r=[],i=Array.prototype.slice,s=this.currentPosition*this.SAMPLE_RATE;for(var o=0,u=n.length;o<u;o++){buffer=n[o],console.log("pre front");var a=i.call(buffer,0,s);console.log("pre back");var f=i.call(buffer,s,buffer.length);r[o]=a.concat(this.clipboard.buffer[o],f),this.onProgress("Pasting buffer...",(o+1)/u*100)}this.importBuffer(r,e)},getDuration:function(){return this.duration},getPlaybackRate:function(){return this.nodes.audioSource.getPlaybackRate()},setReference:function(e){this.reference=e,this.isPlaying=!e,this.pause(),this.play(),this.trigger("reference-change",e)},play:function(){if(!this._enablePlay||!this._enabled)return;this.isStopped=!1,this.isPlaying?this.pause():(this.contextStartTime=this.context.currentTime,this.playFromPosition=this.currentPosition,this.lastFrameTime=0,this.nodes.audioSource.unpause(),this.selection.set?this.nodes.audioSource.start(0,this.currentPosition,this.selection.end-this.currentPosition):this.nodes.audioSource.start(0,this.currentPosition,this.duration-this.currentPosition),this.isPlaying=!0,this.trigger("play"),requestAnimFrame(this.onFrame))},pause:function(){this.nodes.audioSource.stop(0),this.isPlaying=!1,this.trigger("pause")},onFrame:function(){var e;this.isPlaying&&(this.currentPosition+=(this.context.currentTime-this.contextStartTime-this.lastFrameTime)*this.getPlaybackRate(),this.lastFrameTime=this.context.currentTime-this.contextStartTime,requestAnimFrame(this.onFrame),e=this.selection.set?this.selection.end:this.duration,this.currentPosition>=e&&(this.loop?this.restartLoop():this.stop()))},restartLoop:function(){this.stop(),this.selection.set&&(this.currentPosition=this.selection.start),this.play()},setGain:function(e){this.nodes.audioSource.setGain(e)},exportSelection:function(){var e=this;if(!this.enableProcessing)return;this.trigger("status-update","Exporting selection..."),this.getSelectionBuffer(function(t){e.export(t)})},getChannelData:function(){var e=[],t=this.getBuffer();for(var n=0;n<t.numberOfChannels;n++)e.push(t.getChannelData(n));return e},onProgress:function(e,t){this.trigger("status-update",e+" "+t+"%",t)},reconstructBuffer:function(e){var t=[],n=[],r=e.length,i=0;debug.log("AUDIO FILE PLAYER: Reconstructing buffer..."),debug.Timer.start();while(r--)t=t.concat(e[i][0]),n=n.concat(e[i++][1]);return debug.log("AUDIO FILE PLAYER: Buffer reconstructed in "+debug.Timer.stop()+"s"),[t,n]},getSelectionBuffer:function(e){var t=this.getBuffer(),n=this,r=this.getChannelData(),i=this.selection.start*(t.length/t.duration),s=this.selection.end*(t.length/t.duration),o=r[0].length/500;if(!this.selection.set){e(this.getChannelData());return}WorkerManager.addJob({action:"get-selection-buffer",start:i,end:s,data:r,totalProcesses:Math.round(o),split:500,onReconstruct:function(t){e(n.reconstructBuffer(t))},onSplit:this.splitBuffers,onProgress:function(e){n.onProgress("Getting selection...",e)}})},setGainAdjustment:function(e){this.gainAdjustmentFactor=e},normalize:function(e){var t=this;if(!this.enableProcessing)return;this.enableProcessing=!1;var n=this.getChannelData(),r=this.selection.set?Math.round(this.selection.start*this.SAMPLE_RATE):0,i=this.selection.set?Math.round(this.selection.end*this.SAMPLE_RATE):n[0].length,s=n.length,o=[],u=[{start:0,end:0,data:[]}],a=function(e){if(u[e-1]&&u[e].start===u[e-1].end+1){for(var t=0;t<s;t++)u[e].data[t]=u[e-1].data[t]?u[e-1].data[t].concat(u[e].data[t]):u[e].data[t];u[e].start=u[e-1].end,u.remove(u[e-1]),a(e)}if(e>=u.length)return;a(e++)},f=function(){u.sort(function(e,t){return e.start-t.start})};WorkerManager.addJob({action:"get-buffer-max",data:n,start:r,end:i,onReconstruct:function(e){WorkerManager.addJob({action:"normalize-buffer",data:n,max:e[0],start:r,end:i,split:500,onSplit:t.splitBuffers,onReconstruct:function(e){t.importBuffer(u,function(){t.enableProcessing=!0})},onProgress:function(e,n){t.onProgress("Normalizing...",e)}})}})},adjustGain:function(e){var t=this;if(!this.enableProcessing)return;this.enableProcessing=!1,worker.onmessage=function(n){t.importBuffer(_.map(n.data.data,_.arrayTo32Float),e)},this.trigger("status-update","Adjusting gain..."),worker.postMessage({action:"adjust-buffer-gain",data:this.getChannelData(),amount:this.gainAdjustmentFactor,start:this.selection.set?this.selection.start*this.SAMPLE_RATE:0,end:(this.selection.set?this.selection.end:this.getDuration())*this.SAMPLE_RATE})},"export":function(e){var t=this;if(!this.enableProcessing)return;this.enableProcessing=!1;if(!e){var n=this.nodes.audioSource.getBuffer(),e=[];for(var r=0;r<n.numberOfChannels;r++)e.push(n.getChannelData(r))}this.trigger("status-update","Exporting..."),global_relay.trigger("get-recorder",function(n){n.exportWAV(function(e){Recorder.forceDownload(e),t.enableProcessing=!0},"audio/wav",e)})},getPosition:function(){return this.currentPosition},getStartTime:function(){return this.contextStartTime},stop:function(e){this.isPlaying=!1,this.isStopped=!0,this.currentPosition=this.selection.set?this.selection.start:0,this.playFromPosition=0,this.nodes.audioSource.stop(0),this.trigger("stop")},destroy:function(){this.stop(),this.nodes=null,global_relay.off("global-play",this.play),global_relay.off("global-stop",this.stop)}});return n});