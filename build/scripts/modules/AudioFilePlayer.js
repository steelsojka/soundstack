define(["modules/BaseModule","components/AudioFile"],function(e,t){var n=e.extend({init:function(e){_.bindAll(this),_.extend(this,Backbone.Events),this._super.apply(this,arguments),this._enablePlay=!1,this.spectrumType=2,this.currentPosition=0,this.contextStartTime=0,this.playFromPosition=0,this.isPlaying=!1,this.reference=!1,this.selection={},this.clipboard={buffer:[]},this.gainAdjustmentFactor=.5,this.SAMPLE_RATE=44100;var n=new t(this.context);this.nodes.audioSource=n,this.connectToOutput(n),this.enable=function(){this._enabled=!0},this.disable=function(){this.pause(),this._enabled=!1},global_relay.on("global-play",this.play),global_relay.on("global-stop",this.stop)},onFileLoad:function(e,t){var n=e.target.files,r=new FileReader,i=this;this.stop(),r.onload=function(e){i.onFileRead(e,t)},r.readAsArrayBuffer(n[0]),this._enablePlay=!1},getBuffer:function(){return this.nodes.audioSource.getBuffer.apply(this.nodes.audioSource,arguments)},onFileRead:function(e,t){var n=this;n.trigger("status-update","Decoding audio..."),this.nodes.audioSource.decodeAudio(e.target.result,function(){n.onAudioDecode(e,t)})},importBuffer:function(e,t){var n=this;this.nodes.audioSource.setSource(e,function(){n.onAudioDecode({},t)})},onAudioDecode:function(e,t){this._enablePlay=!0;var n=this;this.duration=this.nodes.audioSource.getDuration(),n.trigger("audio-loaded"),typeof t=="function"&&t()},setLoop:function(e){this.loop=e,this.isPlaying&&(this.pause(),this.play())},setRate:function(){this.nodes.audioSource.setRate.apply(this.nodes.audioSource,arguments)},setPosition:function(e){this.currentPosition=e,this.isPlaying&&(this.pause(),this.play())},trimToSelection:function(e){var t=this;t.trigger("status-update","Trimming selection..."),this.getSelectionBuffer(function(n){t.importBuffer(n.data.data,e)})},setSelection:function(e,t){this.selection.start=e,this.selection.end=t,this.selection.set=!0,this.currentPosition=e,this.isPlaying&&(this.pause(),this.play())},clearSelection:function(){this.selection.start=0,this.selection.end=0,this.selection.set=!1},cutSelection:function(e){var t=this;if(!this.selection.set)return;t.trigger("status-update","Cutting selection..."),worker.onmessage=function(n){t.clipboard.buffer=n.data.data.cutBuffers,t.importBuffer(n.data.data.buffers,e)},worker.postMessage({action:"cut-buffer",data:this.getChannelData(),start:this.selection.start*this.SAMPLE_RATE,end:this.selection.end*this.SAMPLE_RATE})},copySelection:function(){var e=this;if(!this.selection.set)return;this.getSelectionBuffer(function(t){e.clipboard.buffer=t.data.data})},insertBuffer:function(e){var t=this;if(this.clipboard.buffer.length===0)return;worker.onmessage=function(n){t.importBuffer(n.data.data,e)},this.trigger("status-update","Pasting..."),worker.postMessage({action:"insert-buffer",data:this.getChannelData(),insertBuffer:this.clipboard.buffer,start:this.currentPosition*this.SAMPLE_RATE})},getDuration:function(){return this.duration},getPlaybackRate:function(){return this.nodes.audioSource.getPlaybackRate()},setReference:function(e){this.reference=e,this.isPlaying=!e,this.pause(),this.play(),this.trigger("reference-change",e)},play:function(){if(!this._enablePlay||!this._enabled)return;this.isStopped=!1,this.isPlaying?this.pause():(this.contextStartTime=this.context.currentTime,this.playFromPosition=this.currentPosition,this.lastFrameTime=0,this.nodes.audioSource.unpause(),this.selection.set?this.nodes.audioSource.start(0,this.currentPosition,this.selection.end-this.currentPosition):this.nodes.audioSource.start(0,this.currentPosition,this.duration-this.currentPosition),this.isPlaying=!0,this.trigger("play"),requestAnimFrame(this.onFrame))},pause:function(){this.nodes.audioSource.stop(0),this.isPlaying=!1,this.trigger("pause")},onFrame:function(){var e;this.isPlaying&&(this.currentPosition+=(this.context.currentTime-this.contextStartTime-this.lastFrameTime)*this.getPlaybackRate(),this.lastFrameTime=this.context.currentTime-this.contextStartTime,requestAnimFrame(this.onFrame),e=this.selection.set?this.selection.end:this.duration,this.currentPosition>=e&&(this.loop?this.restartLoop():this.stop()))},restartLoop:function(){this.stop(),this.selection.set&&(this.currentPosition=this.selection.start),this.play()},setGain:function(e){this.nodes.audioSource.setGain(e)},exportSelection:function(){var e=this;this.trigger("status-update","Exporting selection..."),this.getSelectionBuffer(function(t){e.export(t.data.data)})},getChannelData:function(){var e=[],t=this.getBuffer();for(var n=0;n<t.numberOfChannels;n++)e.push(t.getChannelData(n));return e},getSelectionBuffer:function(e){var t=this.getBuffer(),n=this,r=this.getChannelData();worker.postMessage({action:"get-selection-buffer",data:r,fps:t.length/t.duration,start:this.selection.start,end:this.selection.end}),worker.onmessage=function(t){e(t)}},setGainAdjustment:function(e){this.gainAdjustmentFactor=e},normalize:function(e){var t=this;worker.onmessage=function(n){t.importBuffer(_.map(n.data.data,_.arrayTo32Float),e)},this.trigger("status-update","Normalizing..."),worker.postMessage({action:"normalize-buffer",data:this.getChannelData(),start:this.selection.set?this.selection.start*this.SAMPLE_RATE:0,end:(this.selection.set?this.selection.end:this.getDuration())*this.SAMPLE_RATE})},adjustGain:function(e){var t=this;worker.onmessage=function(n){t.importBuffer(_.map(n.data.data,_.arrayTo32Float),e)},this.trigger("status-update","Adjusting gain..."),worker.postMessage({action:"adjust-buffer-gain",data:this.getChannelData(),amount:this.gainAdjustmentFactor,start:this.selection.set?this.selection.start*this.SAMPLE_RATE:0,end:(this.selection.set?this.selection.end:this.getDuration())*this.SAMPLE_RATE})},"export":function(e){if(!e){var t=this.nodes.audioSource.getBuffer(),e=[];for(var n=0;n<t.numberOfChannels;n++)e.push(t.getChannelData(n))}this.trigger("status-update","Exporting..."),global_relay.trigger("get-recorder",function(t){t.exportWAV(function(e){Recorder.forceDownload(e)},"audio/wav",e)})},getPosition:function(){return this.currentPosition},getStartTime:function(){return this.contextStartTime},stop:function(e){this.isPlaying=!1,this.isStopped=!0,this.currentPosition=this.selection.set?this.selection.start:0,this.playFromPosition=0,this.nodes.audioSource.stop(0),this.trigger("stop")},destroy:function(){this.stop(),this.nodes=null,global_relay.off("global-play",this.play),global_relay.off("global-stop",this.stop)}});return n});